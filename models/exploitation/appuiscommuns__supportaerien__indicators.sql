{#
Example d'exploitation - calcul d'indicateurs agrégés classiques, par commune :
- min et max, de numeric
- ensemble des valeurs rencontrées (dans une commune donc), pour une valeur de dictionnaire
#}

{% set containerUrl = 'http://' + 'datalake.francedatareseau.fr' %}
{% set typeUrlPrefix = containerUrl + '/dc/type/' %}
{% set type = 'eaupotable_canalisation' %} -- _2021 ? from this file ? prefix:typeName ?
{% set typeInd = 'eaupotable_canalisation__indicators' %}
{% set typeName = 'Canalisation' %}
{% set typeNameInd = 'CanalisationIndicator' %}
{% set prefix = 'appuiscommunssupp' %} -- ?
{% set prefixInd = 'appuiscommunssuppind' %} -- ?
{#% set fieldPrefix = prefix + ':' %#}
{% set fieldPrefix = prefix + '__' %}
{#% set fieldPrefixInd = prefixInd + '__' %#}
{% set fieldPrefixInd = prefixInd + '__' %}
{% set idUrlPrefix = typeUrlPrefix + type + '/' %}

select
    count(*) as "{{ fieldPrefixInd }}count",
    MIN("{{ fieldPrefix }}fdrcommune__insee_id") as "{{ fieldPrefix }}fdrcommune__insee_id",
    array_agg("{{ fieldPrefix }}TypePhysique") as "{{ fieldPrefixInd }}TypePhysique__set",
    array_agg("{{ fieldPrefix }}Nature") as "{{ fieldPrefixInd }}Nature__set",
    array_agg("{{ fieldPrefix }}Gestionnaire") as "{{ fieldPrefixInd }}Gestionnaire__set",
    array_agg("{{ fieldPrefix }}Materiau") as "{{ fieldPrefixInd }}Materiau__set",
    MIN("{{ fieldPrefix }}HauteurTotal") as "{{ fieldPrefixInd }}HauteurTotal__min",
    MAX("{{ fieldPrefix }}HauteurTotal") as "{{ fieldPrefixInd }}HauteurTotal__max"
    
    from {{ ref('appuiscommuns_supportaerien_enriched') }}
    group by "{{ fieldPrefix }}fdrcommune__insee_id"